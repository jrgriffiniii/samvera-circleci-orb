description: Bundles and caches a gem.
parameters:
  bundler_version:
    type: string
    default: '2.0.1'
  ruby_version:
    type: string
  project:
    type: string
  require_gemspec:
    type: boolean
    default: true
steps:
  - when:
      condition: << parameters.require_gemspec >>
      steps:
        - restore_cache:
            name: Restore bundle from cache with gemspec
            keys:
              - v1-bundle-{{ checksum "Gemfile" }}--{{ checksum "<< parameters.project >>.gemspec" }}-<< parameters.ruby_version >>

  - unless:
      condition: << parameters.require_gemspec >>
      steps:
        - restore_cache:
            name: Restore bundle from cache without gemspec
            keys:
              - v1-bundle-{{ checksum "Gemfile" }}-<< parameters.ruby_version >>

  - run:
      name: Update bundler
      command: |
        echo 'export BUNDLER_VERSION=<< parameters.bundler_version >>' >> $BASH_ENV
        gem install bundler -v << parameters.bundler_version >>

  - run:
      name: Install dependencies
      command: bundle check || bundle install

  - when:
      condition: << parameters.require_gemspec >>
      steps:
        - save_cache:
            name: Save bundle cache with gemspec
            key: v1-bundle-{{ checksum "Gemfile" }}--{{ checksum "<< parameters.project >>.gemspec" }}-<< parameters.ruby_version >>
            paths:
              - ~/project/vendor/bundle

  - unless:
      condition: << parameters.require_gemspec >>
      steps:
        - save_cache:
            name: Save bundle cache without gemspec
            key: v1-bundle-{{ checksum "Gemfile" }}-<< parameters.ruby_version >>
            paths:
              - ~/project/vendor/bundle
